<!DOCTYPE html>
<html lang="en">
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Diversity in America</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 400px;
			width: 600px;
			max-width: 100%;
			max-height: 100%;
			background: white;
		}
		.title {
			text-align: center;
			font: 600 36px sans-serif;
			padding: 10px;
			margin: 10px;
		}
		.mapbox {
			margin-left: auto;
            margin-right: auto;
			width: 80%;
			aspect-ratio: 16/9;
			border: 2px solid black;
		}
		.scalebox {
			width: auto;
			height: auto;
			margin: 6px auto;
			padding: 2px;
			position: relative;
			font: 400 12px sans-serif;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.about {
			width: 80%;
			margin: 40px auto;
			font: 400 10px sans-serif;
		}
		.about p {
			margin: 8px;
		}
		#scale {
			display: flex;
			height: 1.5em;
			width: 40%;
			border: 1px solid black;
			margin: 4px;
		}
		.colorbar {
			width: 0.5%;
			height: 100%;
		}
		.popup {
			max-height: 400px;
			overflow-y: scroll;
			padding-right:32px;
			font: 400 12px sans-serif;
		}
		.popup-head {
			font: 600 16px sans-serif;
			margin-bottom: 10px;
		}
		.popup-di {
			font: 600 14px sans-serif;
			margin-top: 4px;
			display: flex;
			justify-content: space-between;
		}
		.popup-row div {
			max-width: 80%;
		}
		.popup-row {
			margin-top: 3px;
			display: flex;
			justify-content: space-between;
		}
		.popup-row div {
			max-width: 80%;
			font-size: 1em;
		}
	</style>
	
</head>
<body>

  <div class="title">
	  Diversity in America
  </div>
  <div class="mapbox">
	<div id="map" style="width: 100%; height: 100%;"></div>
  </div>
  <div class="scalebox">
	  No Diversity
	  <div id="scale"></div>
	  Maximum Diversity
  </div>
  <div class="about">
	  <p>
	  Copyright &copy 2022, Darren Erik Vengroff.</p>
	  <p>Based on U.S. Census 2020
	  <a href="https://www.census.gov/programs-surveys/acs">American Community Survey (ACS)</a>
		  5-Year Data.</p>
	  <p>Open source acknowledgements: Analysis done using <a href="https://github.com/vengroff/censusdis">censusdis</a>
	  and
	  <a href="https://github.com/vengroff/divintseg">divintseg</a>.
	  Maps stored using <a href="https://github.com/protomaps/PMTiles">PMTiles</a>.
	  Map rendered in <a href="https://leafletjs.com/">Leaflet</a>
	  with <a href="https://github.com/protomaps/protomaps.js">protomaps.js</a>.
	  </p>
  </div>


    <script src="https://unpkg.com/protomaps@1.23.0/dist/protomaps.min.js"></script>

	<script type="module">
		// This could be imported from colors.js with:
		// import { inferno } from "./js/colors.js";


export class Colormap {
    constructor(colors) {
        this.colors = colors
    }

    get_color(x) {
        var n = this.colors.length

        var ii = Math.round(x * (n - 1))
        var color = this.colors[ii]

        return color
    }

    get_colors() {
    	return this.colors;
    }
}

const hot = new Colormap([
  "rgb(10 0 0)",
  "rgb(13 0 0)",
  "rgb(15 0 0)",
  "rgb(18 0 0)",
  "rgb(21 0 0)",
  "rgb(23 0 0)",
  "rgb(26 0 0)",
  "rgb(28 0 0)",
  "rgb(31 0 0)",
  "rgb(34 0 0)",
  "rgb(36 0 0)",
  "rgb(39 0 0)",
  "rgb(42 0 0)",
  "rgb(44 0 0)",
  "rgb(47 0 0)",
  "rgb(49 0 0)",
  "rgb(52 0 0)",
  "rgb(55 0 0)",
  "rgb(57 0 0)",
  "rgb(60 0 0)",
  "rgb(63 0 0)",
  "rgb(65 0 0)",
  "rgb(68 0 0)",
  "rgb(70 0 0)",
  "rgb(73 0 0)",
  "rgb(76 0 0)",
  "rgb(78 0 0)",
  "rgb(81 0 0)",
  "rgb(84 0 0)",
  "rgb(86 0 0)",
  "rgb(89 0 0)",
  "rgb(91 0 0)",
  "rgb(94 0 0)",
  "rgb(97 0 0)",
  "rgb(99 0 0)",
  "rgb(102 0 0)",
  "rgb(105 0 0)",
  "rgb(107 0 0)",
  "rgb(110 0 0)",
  "rgb(112 0 0)",
  "rgb(115 0 0)",
  "rgb(118 0 0)",
  "rgb(120 0 0)",
  "rgb(123 0 0)",
  "rgb(126 0 0)",
  "rgb(128 0 0)",
  "rgb(131 0 0)",
  "rgb(133 0 0)",
  "rgb(136 0 0)",
  "rgb(139 0 0)",
  "rgb(141 0 0)",
  "rgb(144 0 0)",
  "rgb(147 0 0)",
  "rgb(149 0 0)",
  "rgb(152 0 0)",
  "rgb(154 0 0)",
  "rgb(157 0 0)",
  "rgb(160 0 0)",
  "rgb(162 0 0)",
  "rgb(165 0 0)",
  "rgb(168 0 0)",
  "rgb(170 0 0)",
  "rgb(173 0 0)",
  "rgb(175 0 0)",
  "rgb(178 0 0)",
  "rgb(181 0 0)",
  "rgb(183 0 0)",
  "rgb(186 0 0)",
  "rgb(189 0 0)",
  "rgb(191 0 0)",
  "rgb(194 0 0)",
  "rgb(196 0 0)",
  "rgb(199 0 0)",
  "rgb(202 0 0)",
  "rgb(204 0 0)",
  "rgb(207 0 0)",
  "rgb(210 0 0)",
  "rgb(212 0 0)",
  "rgb(215 0 0)",
  "rgb(217 0 0)",
  "rgb(220 0 0)",
  "rgb(223 0 0)",
  "rgb(225 0 0)",
  "rgb(228 0 0)",
  "rgb(231 0 0)",
  "rgb(233 0 0)",
  "rgb(236 0 0)",
  "rgb(238 0 0)",
  "rgb(241 0 0)",
  "rgb(244 0 0)",
  "rgb(246 0 0)",
  "rgb(249 0 0)",
  "rgb(252 0 0)",
  "rgb(254 0 0)",
  "rgb(255 2 0)",
  "rgb(255 5 0)",
  "rgb(255 7 0)",
  "rgb(255 10 0)",
  "rgb(255 12 0)",
  "rgb(255 15 0)",
  "rgb(255 18 0)",
  "rgb(255 20 0)",
  "rgb(255 23 0)",
  "rgb(255 26 0)",
  "rgb(255 28 0)",
  "rgb(255 31 0)",
  "rgb(255 33 0)",
  "rgb(255 36 0)",
  "rgb(255 39 0)",
  "rgb(255 41 0)",
  "rgb(255 44 0)",
  "rgb(255 47 0)",
  "rgb(255 49 0)",
  "rgb(255 52 0)",
  "rgb(255 54 0)",
  "rgb(255 57 0)",
  "rgb(255 60 0)",
  "rgb(255 62 0)",
  "rgb(255 65 0)",
  "rgb(255 68 0)",
  "rgb(255 70 0)",
  "rgb(255 73 0)",
  "rgb(255 75 0)",
  "rgb(255 78 0)",
  "rgb(255 81 0)",
  "rgb(255 83 0)",
  "rgb(255 86 0)",
  "rgb(255 91 0)",
  "rgb(255 94 0)",
  "rgb(255 96 0)",
  "rgb(255 99 0)",
  "rgb(255 102 0)",
  "rgb(255 104 0)",
  "rgb(255 107 0)",
  "rgb(255 110 0)",
  "rgb(255 112 0)",
  "rgb(255 115 0)",
  "rgb(255 117 0)",
  "rgb(255 120 0)",
  "rgb(255 123 0)",
  "rgb(255 125 0)",
  "rgb(255 128 0)",
  "rgb(255 131 0)",
  "rgb(255 133 0)",
  "rgb(255 136 0)",
  "rgb(255 138 0)",
  "rgb(255 141 0)",
  "rgb(255 144 0)",
  "rgb(255 146 0)",
  "rgb(255 149 0)",
  "rgb(255 151 0)",
  "rgb(255 154 0)",
  "rgb(255 157 0)",
  "rgb(255 159 0)",
  "rgb(255 162 0)",
  "rgb(255 165 0)",
  "rgb(255 167 0)",
  "rgb(255 170 0)",
  "rgb(255 172 0)",
  "rgb(255 175 0)",
  "rgb(255 178 0)",
  "rgb(255 180 0)",
  "rgb(255 183 0)",
  "rgb(255 186 0)",
  "rgb(255 188 0)",
  "rgb(255 191 0)",
  "rgb(255 193 0)",
  "rgb(255 196 0)",
  "rgb(255 199 0)",
  "rgb(255 201 0)",
  "rgb(255 204 0)",
  "rgb(255 207 0)",
  "rgb(255 209 0)",
  "rgb(255 212 0)",
  "rgb(255 214 0)",
  "rgb(255 217 0)",
  "rgb(255 220 0)",
  "rgb(255 222 0)",
  "rgb(255 225 0)",
  "rgb(255 228 0)",
  "rgb(255 230 0)",
  "rgb(255 233 0)",
  "rgb(255 235 0)",
  "rgb(255 238 0)",
  "rgb(255 241 0)",
  "rgb(255 243 0)",
  "rgb(255 246 0)",
  "rgb(255 249 0)",
  "rgb(255 251 0)",
  "rgb(255 254 0)",
  "rgb(255 255 2)",
  "rgb(255 255 6)",
  "rgb(255 255 10)",
  "rgb(255 255 14)",
  "rgb(255 255 18)",
  "rgb(255 255 22)",
  "rgb(255 255 26)",
  "rgb(255 255 30)",
  "rgb(255 255 34)",
  "rgb(255 255 38)",
  "rgb(255 255 42)",
  "rgb(255 255 46)",
  "rgb(255 255 50)",
  "rgb(255 255 54)",
  "rgb(255 255 58)",
  "rgb(255 255 62)",
  "rgb(255 255 65)",
  "rgb(255 255 69)",
  "rgb(255 255 73)",
  "rgb(255 255 77)",
  "rgb(255 255 81)",
  "rgb(255 255 85)",
  "rgb(255 255 89)",
  "rgb(255 255 93)",
  "rgb(255 255 97)",
  "rgb(255 255 101)",
  "rgb(255 255 105)",
  "rgb(255 255 109)",
  "rgb(255 255 113)",
  "rgb(255 255 117)",
  "rgb(255 255 121)",
  "rgb(255 255 125)",
  "rgb(255 255 128)",
  "rgb(255 255 132)",
  "rgb(255 255 136)",
  "rgb(255 255 140)",
  "rgb(255 255 144)",
  "rgb(255 255 148)",
  "rgb(255 255 152)",
  "rgb(255 255 156)",
  "rgb(255 255 160)",
  "rgb(255 255 164)",
  "rgb(255 255 168)",
  "rgb(255 255 172)",
  "rgb(255 255 176)",
  "rgb(255 255 180)",
  "rgb(255 255 184)",
  "rgb(255 255 188)",
  "rgb(255 255 191)",
  "rgb(255 255 195)",
  "rgb(255 255 199)",
  "rgb(255 255 203)",
  "rgb(255 255 207)",
  "rgb(255 255 211)",
  "rgb(255 255 215)",
  "rgb(255 255 219)",
  "rgb(255 255 223)",
  "rgb(255 255 227)",
  "rgb(255 255 231)",
  "rgb(255 255 235)",
  "rgb(255 255 239)",
  "rgb(255 255 243)",
  "rgb(255 255 247)",
  "rgb(255 255 251)",
  "rgb(255 255 255)",
])

		// END of colors.js

	const cmap = hot;

		// text rendering settings
		const line_height = 1.7;
		const text_fill = "rgb(255 248 220)";
		const text_stroke = "rgb(105 105 105)"

		const map = L.map('map').setView([38, -98], 4);

		const tile_layer = L.tileLayer('https://storage.googleapis.com/vengroff-map-test/rastertiles/{z}/{x}/{y}.png', {
			minZoom: 3,
			maxZoom: 8,
			attribution: '<a href="https://github.com/vengroff/censusdis">censusdis</a>'
		})

		const prop_total_population = 'B03002_001E';

		let TRACT_PAINT_RULES = [
			{
				dataLayer:"tracts2020",
				symbolizer:new protomaps.PolygonSymbolizer({
					fill: (z, f) => {
						if (f.props[prop_total_population] == 0) {
							return "rgb(192 192 192)";
						}
 						return cmap.get_color(f.props.diversity);
 					},
					stroke: "rgb(192 192 192)",
					width: 0.5
				})
			}
		];

		let TRACT_LABEL_RULES = []; // ignore for now

		var tract_layer = protomaps.leafletLayer({
			url:'https://storage.googleapis.com/vengroff-map-test/tracts-2020.pmtiles',
			paint_rules:TRACT_PAINT_RULES,
			label_rules:TRACT_LABEL_RULES,
			attribution:''
		})

		const BOUNDARY_PAINT_RULES = [
			{
				dataLayer:"states2020",
				symbolizer:new protomaps.PolygonSymbolizer({
					fill: "transparent",
					stroke: "rgb(127 127 127)",
					width: (z, f) => {
						if (z >= 6)
							return 5;
						if (z >= 5)
							return 3;
						return 1;
					}
				})
			}
		];

		let BOUNDARY_LABEL_RULES = [
			{
				dataLayer: "statesrep2020",
				symbolizer: new protomaps.CenteredTextSymbolizer({
					label_props:["NAME"],
					fill: text_fill,
					width: 2,
					stroke: text_stroke,
					lineHeight: line_height,
					font: (z, f) => {
						if (z <= 5)
							return "600 12px sans-serif";
						if (z <= 7)
							return "600 16px sans-serif";
						return "400 20px sans-serif";
					 }
				}),
				minzoom: 5
			},
			{
				dataLayer: "cities10",
				symbolizer: new protomaps.CenteredTextSymbolizer({
					label_props:["NAME"],
					fill: text_fill,
					width:2,
					lineHeight: line_height,
					stroke: text_stroke,
					font: "400 16px sans-serif"
				}),
				minzoom: 5
			},
			{
				dataLayer: "cities9",
				symbolizer: new protomaps.CenteredTextSymbolizer({
					label_props:["NAME"],
					fill: text_fill,
					width:2,
					lineHeight: line_height,
					stroke: text_stroke,
					font: "400 14px sans-serif"
				}),
				minzoom: 5
			},
			{
				dataLayer: "cities8",
				symbolizer: new protomaps.CenteredTextSymbolizer({
					label_props:["NAME"],
					fill: text_fill,
					width:2,
					lineHeight: line_height,
					stroke: text_stroke,
					font: "300 13px sans-serif"
				}),
				minzoom: 6
			},
			{
				dataLayer: "cities7",
				symbolizer: new protomaps.CenteredTextSymbolizer({
					label_props:["NAME"],
					fill: text_fill,
					width:2,
					lineHeight: line_height,
					stroke: text_stroke,
					font: "300 12px sans-serif"
				}),
				minzoom: 8
			},
			{
				dataLayer: "cities6",
				symbolizer: new protomaps.CenteredTextSymbolizer({
					label_props:["NAME"],
					fill: text_fill,
					width:1,
					lineHeight: line_height,
					stroke: text_stroke,
					font: "200 11px sans-serif"
				}),
				minzoom: 9
			},
		];

		var boundary_layer = protomaps.leafletLayer({
			url:'https://storage.googleapis.com/vengroff-map-test/boundaries-2020.pmtiles',
			paint_rules:BOUNDARY_PAINT_RULES,
			label_rules:BOUNDARY_LABEL_RULES,
			attribution:''
		})

		tile_layer.addTo(map);
		tract_layer.addTo(map)
		boundary_layer.addTo(map)

		map.options.minZoom = 4;
		map.options.maxZoom = 13;

		map.setMaxBounds(map.getBounds());

	// tract_layer.addInspector(map)

	// Pop-up for tracts.

	const census_prop_names = {
		B03002_001E: "Total Population",
		B03002_003E: "Non-Hispanic White",
		B03002_004E: "Non-Hispanic Black or African American",
		B03002_005E: "Non-Hispanic American Indian and Alaska Native",
		B03002_006E: "Non-Hispanic Asian",
		B03002_007E: "Non-Hispanic Native Hawaiian and Other Pacific Islander",
		B03002_008E: "Non-Hispanic Some Other Race",
		B03002_010E: "Non-Hispanic Two or more races: Two races including Some other race",
		B03002_011E: "Non-Hispanic Two or more races: Two races excluding Some other race, and three or more races",

		B03002_013E: "Hispanic or Latino White",
		B03002_014E: "Hispanic or Latino Black or African American",
		B03002_015E: "Hispanic or Latino American Indian and Alaska Native",
		B03002_016E: "Hispanic or Latino Asian",
		B03002_017E: "Hispanic or Latino Native Hawaiian and Other Pacific Islander",
		B03002_018E: "Hispanic or Latino Some Other Race",
		B03002_020E: "Hispanic or Latino Two or more races: Two races including Some other race",
		B03002_021E: "Hispanic or Latino Two or more races: Two races excluding Some other race, and three or more races",

	}

	function numberWithCommas(x) {
		return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}

	function on_map_click(ev) {
		let wrapped = map.wrapLatLng(ev.latlng);

		let resultsBySourceName = tract_layer.queryFeatures(wrapped.lng, wrapped.lat);

		for (var [sourceName, results] of resultsBySourceName) {
		  if(results.length > 0) {
			  for (var result of results) {
				var props = result.feature.props;

				var content = `<div class="popup-head">Census Tract ${props['TRACT']} in ${props['COUNTY_NAME']}</div>`;

				content = content + `<div class="popup-di""><div>${census_prop_names[prop_total_population]}</div><div>${numberWithCommas(props[prop_total_population])}</div></div>`;
				content = content + `<div class="popup-di"><div>Diversity</div><div>${Math.round(100 * props['diversity'])}%</div></div>`;
				content = content + `<div class="popup-di" style="margin-bottom: 10px"><div>Integration</div><div>${Math.round(100 * props['integration'])}%</div></div>`;

				for (const prop in props) {
					if (prop !== prop_total_population) {
						if (prop in census_prop_names) {
							if (props[prop] > 0) {
								content = content + `<div class="popup-row"><div>${census_prop_names[prop]}</div><div>${numberWithCommas(props[prop])}</div></div>`;
							}
						}
					}
				}
			  }

			L.popup()
			  .setLatLng(ev.latlng)
			  .setContent(
				'<div class="popup">' +
				  content +
				  "</div>"
			  )
			  .openOn(map);
			}
		}
	}

	map.on("click", on_map_click)

	// Fill in the color scale.

	const scale = document.getElementById("scale");

	console.log(scale);

	for(const color of cmap.get_colors()) {

		const bar = document.createElement('div');
		bar.className = "colorbar";
		bar.style.backgroundColor = color;

		scale.appendChild(bar);
	}

  </script>

</body>
</html>
